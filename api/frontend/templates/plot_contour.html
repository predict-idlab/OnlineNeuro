<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Contour plot</title>
    <script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
</head>
<body style="margin: 0;">
    <div id="contour-div-{{ plot_id }}" style="width: 100%; width:300px; height: 300px;"></div>
    <script>
        // Adjust the port in your Flask app if needed
        console.log("Socket connection port:", '{{ port }}');  // Add this line for debugging
        const socket = io.connect('http://localhost:{{ port }}',  { transports: ['websocket', 'polling'] });  // Ensure port is passed by Flask or hardcoded
        const plotId = '{{ plot_id }}';  // unique per plot
        const divId = 'contour-div-' + plotId;
        let isFirstCall = true; // Flag to check if it's the first call
        let contourPlotData = []; // This will hold our trace configuration

        // This plot cant be updated once at a time, instead is generated at every call fully.
        let data = [{
            x: [],
            y: [],
            z: [],
            type : 'contour',
            colorscale: 'Jet',
            contours: {coloring : 'heatmap'},
        }]

        let layout = {
            title: 'Contour plot', // This is updated
            paper_bgcolor: 'black',
            plot_bgcolor: 'black',
            font: { color: 'white' },

            xaxis: {
                title: 'X Axis', // This is updated
                gridcolor: 'gray',
                zerolinecolor: 'gray',
                showgrid: true
            },
            yaxis: {
                title: 'Y Axis', // This is updated
                gridcolor: 'gray',
                zerolinecolor: 'gray',
                showgrid: true
            },
            margin: { l: 30, r: 30, t: 30, b: 30 },
        };

        socket.on('contour-' + plotId, function(newData) {
            if (!newData || !newData.data || !newData.meta) {
                console.warn("Received data is missing 'data' or 'meta' property.", newData);
                return; // Stop execution if data is incomplete
            }

            const plotData = newData.data;
            const meta = newData.meta;

            if (isFirstCall){

                if (meta.title) layout.title = meta.title;
                if (meta.xaxis_title) layout.xaxis.title = meta.xaxis_title;
                if (meta.yaxis_title) layout.yaxis.title = meta.yaxis_title;

                let xVals, yVals;

                if (meta.xticks && Array.isArray(meta.xticks)) {
                    xVals = meta.xticks;
                } else {
                    const Nx = meta.grid_size_x || meta.grid_size;  // fallback
                    xVals = [...Array(Nx).keys()];
                }

                if (meta.yticks && Array.isArray(meta.yticks)) {
                    yVals = meta.yticks;
                } else {
                    const Ny = meta.grid_size_y || meta.grid_size;  // fallback
                    yVals = [...Array(Ny).keys()];
                }

                contourPlotData = [{
                    x: xVals,
                    y: yVals,
                    z: plotData.z,
                    type: 'heatmap',
                    colorscale: 'Jet',
                    zmin: meta.zmin !== null ? meta.zmin : undefined,
                    zmax: meta.zmax !== null ? meta.zmax : undefined,
                    contours: {
                        coloring: 'heatmap',   // filled colors like heatmap
                        showlines: true        // contour lines on top
                    },
                    colorbar: {
                        tickformat: ".2f"  // restrict to 2 decimal places
                    }
                }];

                Plotly.newPlot(divId, contourPlotData, layout); // Create the initial plot
                isFirstCall = false; // Mark as initialized

            } else{
                Plotly.update(divId, { z: [plotData.z] }, {}, [0]);
            }
            console.log("Contour Plot updated successfully.");
        });

        socket.on('connect', () => console.log('Successfully connected!'));
        socket.on('disconnect', () => console.log('Socket disconnected!'));

    </script>
    <script>
        window.__PLOT_DIV_ID__ = 'contour-div-{{ plot_id }}';
    </script>
    <script src="/static/js/theme-sync.js"></script>
</body>
</html>
